overall_status: "in-progress"
files_modified:
  - path: "internal/core/ports/filesystem.go"
    status: "modified"
    summary: "Defined FileSystem interface, RealFileSystem implementation, and added go:generate directive."
  - path: "internal/project/project.go"
    status: "modified"
    summary: "Defined service interfaces, refactored for DI, updated methods for FileSystem, updated EnsurePhaseFiles call, added go:generate directive. Defined ProjectService interface and added go:generate for it. Updated go:generate for internal service mocks."
  - path: "internal/core/session/session.go"
    status: "modified"
    summary: "Injected FileSystem into Storage and updated methods to use it."
  - path: "internal/core/feature/feature.go"
    status: "modified"
    summary: "Injected FileSystem into Service and updated methods to use it."
  - path: "internal/core/rules/rules.go"
    status: "modified"
    summary: "Defined Generator interface, injected FileSystem and Generator into Service, updated methods."
  - path: "internal/mcp/server.go"
    status: "modified"
    summary: "Updated project.New call to provide new service dependencies."
  - path: "internal/cli/command/init.go"
    status: "modified"
    summary: "Updated project.New call to provide new service dependencies. Refactored to use an injected ProjectService field instead of projectFactory."
  - path: "internal/cli/command/create.go"
    status: "modified"
    summary: "Updated project.New call to provide new service dependencies. Refactored to use an injected ProjectService field instead of projectFactory."
  - path: "internal/core/phase/phase.go"
    status: "modified"
    summary: "Injected FileSystem into EnsurePhaseFiles and updated to use it."
  - path: "internal/project/project_test.go"
    status: "created"
    summary: "Created unit tests for project package using gomock, covering New, IsInitialized, RequiresInitialized, Init, CreateFeature, ChangePhase."
  # Mocks generated by go generate - not manually edited
  - path: "internal/core/ports/mocks/mock_filesystem.go"
    status: "generated"
    summary: "Generated gomock mock for ports.FileSystem."
  - path: "internal/project/mocks/mock_interfaces.go"
    status: "generated"
    summary: "Generated gomock mocks for project service interfaces."
  - path: "internal/cli/command/types.go"
    status: "modified"
    summary: "Removed projectFactory variable."
  - path: "internal/cli/command/init_test.go"
    status: "modified"
    summary: "Refactored tests to inject MockProjectService into InitCommand.run method."
  - path: "internal/project/mocks/mock_project_service.go"
    status: "generated"
    summary: "Generated gomock mock for project.ProjectService interface."
  - path: "internal/project/project_interfaces_mocks_test.go"
    status: "generated"
    summary: "Generated gomock mocks for project internal service interfaces (StorageService, etc.) into package project."
  - path: "internal/core/rules/rules_test.go"
    status: "created"
    summary: "Added unit tests for RuleGenerator and rules.Service using gomock."
  - path: "internal/core/rules/mocks/mock_generator.go"
    status: "generated"
    summary: "Generated gomock mock for rules.Generator interface."
  - path: "internal/core/feature/feature_test.go"
    status: "created"
    summary: "Added unit tests for feature.Service methods using gomock."
  - path: "internal/core/phase/phase_test.go"
    status: "created"
    summary: "Added unit tests for phase.EnsurePhaseFiles using gomock."
  - path: "internal/cli/command/create_test.go"
    status: "created"
    summary: "Added unit tests for CreateCommand using MockProjectService."
  - path: "internal/cli/command/serve_test.go"
    status: "created"
    summary: "Added unit tests for ServeCommand and NewServeCommand functions."
  - path: "internal/mcp/tools/tools_test.go"
    status: "modified"
    summary: "Added unit tests for HandleInit and HandleCreate MCP tool handlers using MockProjectService."

tasks:
  - id: "step-1"
    name: "Establish `FileSystem` Port and Adapter"
    description: |
      - In a shared package (e.g., `internal/core/ports`), define a `FileSystem` interface (e.g., `ports.FileSystem`) with common file operations (`Stat`, `ReadFile`, `WriteFile`, `MkdirAll`, `ReadDir`, `Create`).
      - In the same package, implement a concrete `RealFileSystem` (e.g., `ports.RealFileSystem`) that wraps the standard `os` package functions.
      - In the main application setup (e.g., `d3/main.go` or `internal/cli`), instantiate this `RealFileSystem`. This instance will be used for subsequent dependency injections.
      (This step ensures the FileSystem provider is ready and the application builds).
    status: "completed"

  - id: "step-2"
    name: "Inject `FileSystem` into `internal/core/session.Storage`"
    description: |
      - Modify `session.NewStorage` (or equivalent constructor) to accept an argument of type `ports.FileSystem`.
      - Update methods within `session.Storage` to use the injected `FileSystem` interface instead of direct `os` calls.
      - Update the main application setup to pass the `RealFileSystem` instance (from Step 1) when creating `session.Storage`.
      (This step refactors session.Storage and ensures the application builds).
    status: "completed"

  - id: "step-3"
    name: "Inject `FileSystem` into `internal/core/feature.Service`"
    description: |
      - Modify `feature.NewService` to accept `ports.FileSystem`.
      - Update methods within `feature.Service` to use the injected `FileSystem`.
      - Update the main application setup to pass the `RealFileSystem` instance when creating `feature.Service`.
      (Ensures buildable state).
    status: "completed"

  - id: "step-4"
    name: "Refactor `internal/core/rules.Service` for Dependency Injection"
    description: |
      - Define a `Generator` interface *within* the `internal/core/rules` package (e.g., `type Generator interface { GenerateRuleStubs(...) ... }`) to represent the rule generation capabilities currently provided by `rules.RuleGenerator`.
      - Ensure the existing concrete `rules.RuleGenerator` struct implements this new `rules.Generator` interface.
      - Modify `rules.NewService` to accept `ports.FileSystem` and `rules.Generator` as arguments.
      - Update methods within `rules.Service` to use the injected `FileSystem` and `Generator`.
      - Update the main application setup:
          - Instantiate `rules.RuleGenerator` (if it has its own dependencies, ensure they are provided or refactored similarly if they involve `os` calls).
          - Pass the `RealFileSystem` instance and the `rules.RuleGenerator` instance (as `rules.Generator`) when creating `rules.Service`.
      (Ensures buildable state).
    status: "completed"

  - id: "step-5"
    name: "Refactor `internal/project.Project` for Dependency Injection and `FileSystem` Usage"
    description: |
      - Define service-specific interfaces *within* the `internal/project` package for the services `Project` depends on (e.g., `type Storage interface { GetSession() ... }` for `session.Storage`, `type FeatureService interface { ... }`, `type RulesService interface { ... }`).
      - Ensure the existing `internal/core/session.Storage`, `internal/core/feature.Service`, and `internal/core/rules.Service` structs (and their constructors) are compatible with and satisfy these new `project`-local interfaces. This might involve ensuring method signatures match.
      - Modify `project.New` (or equivalent constructor for `Project`) to accept arguments for these `project`-local service interfaces (e.g., `project.Storage`, `project.FeatureService`, `project.RulesService`) AND an argument of type `ports.FileSystem`. The `FileSystem` is for `Project`'s direct use or for passing to callees like `EnsurePhaseFiles`.
      - Update methods within `project.Project` to use the injected service interfaces and the injected `FileSystem`.
      - Update the main application setup to:
          - Pass the already-refactored `session.Storage`, `feature.Service`, and `rules.Service` instances (which now satisfy the `project`-local interfaces) when creating `project.Project`.
          - Pass the `RealFileSystem` instance to `project.New`.
      (Ensures buildable state).
    status: "completed"

  - id: "step-6"
    name: "Inject `FileSystem` into `internal/core/phase.EnsurePhaseFiles`"
    description: |
      - Modify the function signature of `phase.EnsurePhaseFiles` to accept `ports.FileSystem` as an argument.
      - Update the implementation of `phase.EnsurePhaseFiles` to use the injected `FileSystem`.
      - Update all call sites of `phase.EnsurePhaseFiles` (e.g., within `project.Project.ChangePhase`) to pass the required `ports.FileSystem` instance. (`project.Project` should now have access to `FileSystem` via DI from Step 5).
      (Ensures buildable state).
    status: "completed"

  - id: "step-7"
    name: "Implement Unit Tests for `internal/project`"
    description: |
      - Write tests for `Project` methods, using mock/fake implementations of its dependencies (`Storage`, `FeatureService`, `RulesService`, `FileSystem`) passed via interfaces. # Note: Implementation used gomock.
    status: "completed"

  - id: "step-8"
    name: "Implement Unit Tests for `internal/core/session`"
    description: |
      - Write tests for `session.Storage` methods, using a `gomock`-generated mock `FileSystem`.
      - Write tests for `Phase` methods and `ParsePhase`.
    status: "completed"

  - id: "step-9"
    name: "Implement Unit Tests for `internal/core/rules`"
    description: |
      - Write tests for `rules.Service` methods, using `gomock`-generated mock `FileSystem` and `Generator` interfaces.
      - (Optional: Write tests for `rules.RuleGenerator` methods separately if its complexity warrants it, potentially requiring further `FileSystem` DI into `RuleGenerator` itself if it uses `os` directly).
    status: "completed"

  - id: "step-10"
    name: "Implement Unit Tests for `internal/core/feature`"
    description: |
      - Write tests for `feature.Service` methods, using a `gomock`-generated mock `FileSystem`.
    status: "completed"

  - id: "step-11"
    name: "Implement Unit Tests for `internal/core/phase`"
    description: |
      - Write tests for `phase.EnsurePhaseFiles`, using a `gomock`-generated mock `FileSystem`.
    status: "completed"

  - id: "step-11.5"
    name: "Define ProjectService Interface and Refactor CLI/MCP for DI"
    description: |
      - Defined `project.ProjectService` interface.
      - Generated `MockProjectService` using gomock.
      - Refactored `InitCommand` and `CreateCommand` in `internal/cli/command` to use `ProjectService` via an unexported field, removing the global `projectFactory`.
    status: "completed"

  - id: "step-12"
    name: "Implement Unit Tests for `internal/cli`"
    description: |
      - Wrote tests for `InitCommand.run` and `CreateCommand.run` methods in `internal/cli/command`, injecting `MockProjectService`.
      - Added tests for `ServeCommand.Run` and core functions.
      - Optionally, add integration-style tests for `cli.Execute` using Cobra's testing helpers if deemed necessary.
    status: "completed"

  - id: "step-13"
    name: "Implement Unit Tests for `internal/mcp`"
    description: |
      - Write tests for MCP tool handlers (e.g., `HandleMove`), passing in a `gomock`-generated mock `ProjectService`.
    status: "completed"

  - id: "step-14"
    name: "Integrate Tests into CI Pipeline"
    description: |
      - Modify the relevant GitHub Actions workflow to add a step executing `go test ./...` before build/release jobs.
    status: "completed"
